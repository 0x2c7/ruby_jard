# frozen_string_literal: true

RSpec.describe 'RubyJard::LayoutPicker integrations test', integration: true do
  let(:work_dir) { File.join(RSPEC_ROOT, '/ruby_jard') }

  context 'when the window is enormous' do
    it 'picks wide layout' do
      test = JardIntegrationTest.new(
        work_dir, "bundle exec ruby -e \"require 'ruby_jard'\njard\na = 1\"",
        width: 130, height: 30
      )
      test.start
      expect(test.screen_content).to match_repl(<<~SCREEN)
        ┌ Source  -e:3 ─────────────────────────────────────────────────┬ Variables ─────────────────────────────────────────────────────┐
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        ├ Backtrace  1 frames ──────────────────────────────────────────┼ Threads  1 threads ────────────────────────────────────────────┤
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        │???????????????????????????????????????????????????????????????│????????????????????????????????????????????????????????????????│
        ├───────────────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────┤
        │????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????│
        └────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
        jard >>
      SCREEN
    ensure
      test.stop
    end
  end

  context 'when the window can only fit 1 screen' do
    it 'picks tiny layout' do
      test = JardIntegrationTest.new(
        work_dir, "bundle exec ruby -e \"require 'ruby_jard'\njard\na = 1\"",
        width: 30, height: 30
      )
      test.start
      expect(test.screen_content).to match_repl(<<~SCREEN)
        ┌ Source  -e:3 ──────────────┐
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        └────────────────────────────┘
        jard >>
      SCREEN
    ensure
      test.stop
    end
  end

  context 'when the screen tiny' do
    it 'picks WideLayout' do
      test = JardIntegrationTest.new(
        work_dir, "bundle exec ruby -e \"require 'ruby_jard'\njard\na = 1\"",
        width: 30, height: 30
      )
      test.start
      expect(test.screen_content).to match_repl(<<~SCREEN)
        ┌ Source  -e:3 ──────────────┐
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        │????????????????????????????│
        └────────────────────────────┘
        jard >>
      SCREEN
    ensure
      test.stop
    end
  end

  context 'when the screen is short, but wide' do
    it 'picks narrow horizontal layout' do
      test = JardIntegrationTest.new(
        work_dir, "bundle exec ruby -e \"require 'ruby_jard'\njard\na = 1\"",
        width: 130, height: 15
      )
      test.start
      expect(test.screen_content).to match_repl(<<~SCREEN)
        ┌ Source  -e:3 ──────────────────────────────────────────────────────────────┬ Variables ────────────────────────────────────────┐
        │????????????????????????????????????????????????????????????????????????????│???????????????????????????????????????????????????│
        │????????????????????????????????????????????????????????????????????????????│???????????????????????????????????????????????????│
        │????????????????????????????????????????????????????????????????????????????│???????????????????????????????????????????????????│
        │????????????????????????????????????????????????????????????????????????????│???????????????????????????????????????????????????│
        │????????????????????????????????????????????????????????????????????????????│???????????????????????????????????????????????????│
        │????????????????????????????????????????????????????????????????????????????│???????????????????????????????????????????????????│
        │????????????????????????????????????????????????????????????????????????????│???????????????????????????????????????????????????│
        │????????????????????????????????????????????????????????????????????????????│???????????????????????????????????????????????????│
        │????????????????????????????????????????????????????????????????????????????│???????????????????????????????????????????????????│
        │????????????????????????????????????????????????????????????????????????????│???????????????????????????????????????????????????│
        └────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────┘
        jard >>
      SCREEN
    ensure
      test.stop
    end
  end

  context 'when the screen is tall, but narrow' do
    it 'picks narrow vertical layout' do
      test = JardIntegrationTest.new(
        work_dir, "bundle exec ruby -e \"require 'ruby_jard'\njard\na = 1\"",
        width: 50, height: 50
      )
      test.start
      expect(test.screen_content).to match_repl(<<~SCREEN)
        ┌ Source  -e:3 ──────────────────────────────────┐
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        ├ Variables ─────────────────────────────────────┤
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        │????????????????????????????????????????????????│
        ├────────────────────────────────────────────────┤
        │????????????????????????????????????????????????│
        └────────────────────────────────────────────────┘
        jard >>
      SCREEN
    ensure
      test.stop
    end
  end
end
